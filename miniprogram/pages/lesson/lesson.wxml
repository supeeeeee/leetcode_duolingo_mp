<!--pages/lesson/lesson.wxml-->
<view class="container" style="justify-content: flex-start;">

  <!-- Empty View -->
  <view wx:if="{{isEmpty}}" class="result-view animate-pop">
    <view class="result-header">
      <text class="result-emoji">ğŸ§­</text>
      <text class="result-title">{{emptyTitle}}</text>
      <text class="empty-desc">{{emptyHint}}</text>
    </view>
    <button class="btn" bindtap="goToPath">{{emptyCtaText}}</button>
  </view>

  <!-- Result View -->
  <view wx:elif="{{finished}}" class="result-view animate-pop">
    <view class="result-header">
      <text class="result-emoji">ğŸ‰</text>
      <text class="result-title">è¯¾ç¨‹å®Œæˆï¼</text>
    </view>

    <view class="stat-row">
      <view class="stat-item">
        <text class="stat-val xp">+{{earnedXP}}</text>
        <text class="stat-label">è·å¾—ç»éªŒ</text>
      </view>
      <view class="stat-item">
        <text class="stat-val">{{accuracy}}%</text>
        <text class="stat-label">æ­£ç¡®ç‡</text>
      </view>
    </view>

    <button class="btn" bindtap="goBack">ç»§ç»­</button>
  </view>

  <!-- Quiz View -->
  <block wx:else>
    <!-- Progress Header -->
    <view class="quiz-header">
      <view class="close-btn" bindtap="goBack">âœ•</view>
      <view class="quiz-progress-bar">
        <view class="quiz-progress-fill" style="width: {{ totalQuestions ? ((currentIndex + 1) / totalQuestions) * 100 : 0 }}%"></view>
      </view>
      <text class="quiz-progress-text">{{currentIndex + 1}}/{{totalQuestions}}</text>
    </view>

    <!-- Question Area -->
    <view class="question-area">
      <view class="question-header-row">
        <view class="question-main">
          <text class="question-text">{{currentQuestion.question}}</text>
          <text class="track-tag {{currentQuestion.track === 'core' ? 'core' : 'extra'}}">{{currentQuestion.track === 'core' ? 'æ ¸å¿ƒ' : 'æ‰©å±•'}}</text>
        </view>
        <view class="detail-toggle" bindtap="toggleDetail">
          <text class="toggle-icon">{{showDetail ? 'ğŸ“–' : 'ğŸ“˜'}}</text>
          <text class="toggle-text">{{showDetail ? 'éšè—è¯¦æƒ…' : 'è¯¦ç»†æè¿°'}}</text>
        </view>
      </view>

      <view wx:if="{{showDetail}}" class="description-card animate-fade">
        <text class="description-content">{{currentQuestion.description}}</text>
      </view>

      <view wx:if="{{currentQuestion.codeSnippet}}" class="code-container">
        <view class="lang-selector">
          <view 
            wx:for="{{availableLangs}}" 
            wx:key="*this" 
            class="lang-tab {{selectedLang === item ? 'active' : ''}}" 
            bindtap="switchLang" 
            data-lang="{{item}}"
          >{{item}}</view>
        </view>
        <view class="code-block">
          <rich-text nodes="{{highlightedCode}}"></rich-text>
        </view>
      </view>
    </view>

    <!-- Options Area -->
    <view class="options-area {{shakeActive ? 'animate-shake' : ''}}">
      <block wx:for="{{currentQuestion.options}}" wx:key="*this">
        <view
          class="option-card {{selectedOption === index ? 'selected' : ''}} {{status !== 'answering' && index === currentQuestion.correctIndex ? 'correct' : ''}} {{status === 'checked_wrong' && selectedOption === index ? 'wrong' : ''}}"
          bindtap="selectOption"
          data-index="{{index}}"
        >
          <view class="option-key">{{['A','B','C','D'][index] || (index + 1)}}</view>
          <text class="option-text">{{item}}</text>
        </view>
      </block>
    </view>

    <!-- Footer Action (fixed layout to avoid jump) -->
    <view class="footer {{status === 'checked_correct' ? 'footer-correct' : (status === 'checked_wrong' ? 'footer-wrong' : '')}} {{status !== 'answering' ? 'animate-slide-up' : ''}}">
      <view class="feedback-wrap">
        <view wx:if="{{status !== 'answering'}}" class="feedback-msg animate-pop">
          <view class="feedback-title">{{status === 'checked_correct' ? 'æ­£ç¡®ï¼' : 'é”™è¯¯'}}</view>
          <view class="feedback-desc">{{currentQuestion.explanation}}</view>
          <view wx:if="{{currentQuestion.learning}}" class="thinking-card">
            <view class="thinking-item"><text class="thinking-label">æ ¸å¿ƒå¿ƒæ³•ï¼š</text><text class="thinking-value">{{currentQuestion.learning.insight}}</text></view>
            <view class="thinking-item"><text class="thinking-label">è§£é¢˜æ¨¡æ¿ï¼š</text>
              <view class="template-box">
                <text class="template-text">{{currentQuestion.learning.template}}</text>
              </view>
            </view>
            <view class="thinking-item"><text class="thinking-label">æ˜“é”™ç‚¹ï¼š</text><text class="thinking-value">{{currentQuestion.learning.pitfalls[0]}}</text></view>
          </view>
        </view>
      </view>

      <button class="btn {{status === 'answering' && selectedOption === null ? 'disabled' : ''}}" bindtap="handleAction">
        {{status === 'answering' ? 'æ£€æŸ¥' : 'ä¸‹ä¸€æ­¥'}}
      </button>
    </view>
  </block>

</view>
